{% extends "extends/base.html" %}
{% load widget_tweaks %}
{% load static %}

{% block head_js %}
    <!-- Tempus Dominus JS -->
    <script src="{% static 'libs/tempusdominus-bootstrap-5.39/moment-with-locales.min.js' %}"></script>
    <script src="{% static 'libs/tempusdominus-bootstrap-5.39/tempusdominus-bootstrap-4.min.js' %}"></script>
{% endblock head_js %}

{% block head_css %}
    <!-- Tempus Dominus CSS -->
    <link href="{% static 'libs/tempusdominus-bootstrap-5.39/tempusdominus-bootstrap-4.min.css' %}" media="all"
          rel="stylesheet">
    <style>
        img {
            max-width: 300px;
            max-height: 300px;
        }
    </style>
{% endblock head_css %}

{% block breadcrumbs %}
    <ol class="breadcrumb float-sm-right">
        <li class="breadcrumb-item"><a href="{% url 'index' %}">Inicio</a></li>
        <li class="breadcrumb-item"><a href="{% url 'admin-socio-listado' %}">Socios</a></li>
        <li class="breadcrumb-item active">{{ title }}</li>
    </ol>
{% endblock %}

{% block content %}
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <form method="post" enctype="multipart/form-data" id="formSocio">
                    {% csrf_token %}
                    <div class="card">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-12 col-md-6">
                                    <h4>Datos Personales</h4>
                                    <hr>
                                    <div class="form-group">
                                        <div class="input-group">
                                            {{ form.persona }}
                                            <div class="input-group-append">
                                                <a href="{% url 'admin-persona-crear' %}?next={{ request.path }}"
                                                   class="btn btn-success">
                                                    <i class="fas fa-user-plus"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                    <ul id="list-data" class="list-group">
                                    </ul>
                                </div>
                                <div class="col-12 col-md-6">
                                    <h4>Datos del socio</h4>
                                    <hr>
                                    <div class="form-group">
                                        <div class="input-group" data-target-input="nearest">
                                            {{ form.fecha_ingreso }}
                                            <div class="input-group-append" data-target="#id_fecha_ingreso"
                                                 data-toggle="datetimepicker">
                                                <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-primary float-right" type="submit">
                                <i class="fa fa-save"></i> Guardar
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock content %}
{% block body_js %}
    <script>
        let selectPersona = $('#id_persona');

        selectPersona.select2({
            theme: 'bootstrap4',
            allowClear: true,
            placeholder: 'Seleccione una persona',
            language: 'es'
        });
        $('#id_fecha_ingreso').datetimepicker({
            "format": "DD/MM/YYYY",
            "locale": "es-AR",
            "date": null,
            "minDate": "01/01/1900",
            "maxDate": Date.now(),
        });

        selectPersona.on('change', function (e) {
            let listDataPersona = $('#list-data');
            if ($(this).val()) {
                $.ajax({
                    url: "{% url 'admin-socio-ajax' %}",
                    type: 'GET',
                    data: {
                        'action': 'get_persona',
                        'id': $(this).val()
                    },
                    dataType: 'json',
                    success: function (data) {
                        if (!data.hasOwnProperty('error')) {
                            listDataPersona.empty();
                            let persona = data['persona'];
                            listDataPersona.append('<li class="list-group-item list-group-item-secondary"><h5 class="m-0">Datos de la persona seleccionada</h5></li>');
                            listDataPersona.append('<li class="list-group-item"><b>CUIL:</b> ' + persona['cuil'] + '</li>');
                            listDataPersona.append('<li class="list-group-item"><b>Nombre:</b> ' + persona['nombre'] + '</li>');
                            listDataPersona.append('<li class="list-group-item"><b>Apellido:</b> ' + persona['apellido'] + '</li>');
                            listDataPersona.append('<li class="list-group-item"><b>Edad:</b> ' + persona['edad'] + '</li>');
                            listDataPersona.append('<li class="list-group-item"><p><b>Foto carnet:</b></p>' +
                                '<img src="' + persona['imagen'] + '" class="img-thumbnail" alt=""></li>');
                            listDataPersona.append('<li class="list-group-item"><a href="' + persona['url_editar'] + '" class="btn btn-warning"><i class="fas fa-user-pen"></i> Editar persona</a></li>');
                        } else {
                            alert('Error al obtener los datos de la persona: ' + data.error)
                        }
                    }
                });
            } else {
                listDataPersona.empty();
            }
        });

        // Submit form
        $('#formSocio').submit(function (e) {
            e.preventDefault();
            let form = new FormData(this);
            form.append('action', '{{ action }}');
            $.ajax({
                url: window.location.pathname,
                type: 'POST',
                data: form,
                dataType: 'json',
                contentType: false,
                processData: false,
                success: function (data) {
                    if (!data.hasOwnProperty('error')) {
                        Swal.fire({
                            position: 'top-end',
                            title: 'Socio agregado',
                            text: 'El socio se agreg贸 correctamente',
                            icon: 'success',
                            confirmButtonText: 'Imprimir comprobante de operaci贸n',
                            showCancelButton: true,
                            cancelButtonText: 'Continuar',
                        }).then((result) => {
                            if (result.isConfirmed) {
                                $.ajax({
                                    url: "{% url 'admin-socio-ajax' %}",
                                    type: "GET",
                                    data: {
                                        'action': 'print_comprobante',
                                        'persona': data['persona'],
                                        'socio': data['socio'],
                                    },
                                    success: function (data) {
                                        if (data['url']) {
                                            window.open(data['url'], '_blank');
                                        }
                                    },
                                    error: function (data) {
                                        console.log('Error:', data);
                                    }
                                });
                            }
                            window.location.href = "{% url 'admin-socio-listado' %}";
                        });
                    } else {
                        let errors = []
                        if (typeof data.error === 'object') {
                            $.each(data.error, function (key, value) {
                                errors.push(value);
                            });
                        } else {
                            errors = data.error
                        }
                        Swal.fire({
                            position: 'top-end',
                            icon: 'error',
                            title: 'Ocurri贸 un error',
                            text: errors,
                            showConfirmButton: true,
                        })
                    }
                },
                error: function (data) {
                    alert('Error en la petici贸n ajax en el submit del formulario: ' + data);
                }
            });
        });
    </script>
{% endblock body_js %}
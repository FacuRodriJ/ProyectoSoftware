<div class="modal fade" id="ModalAddPersona" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
    <form id="formPersona" method="post" enctype="multipart/form-data">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ModalLabel">
                        <b><i class="fas fa-user-plus"></i> Nuevo registro de una persona</b>
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="form-group">
                        {{ persona_form.dni }}
                    </div>
                    <div class="form-group">
                        {{ persona_form.nombre }}
                    </div>
                    <div class="form-group">
                        {{ persona_form.apellido }}
                    </div>
                    <div class="form-group">
                        {{ persona_form.sexo }}
                    </div>
                    <div class="form-group">
                        <div class="input-group" data-target-input="nearest">
                            {{ persona_form.fecha_nacimiento }}
                            <div class="input-group-append" data-target="#id_fecha_nacimiento"
                                 data-toggle="datetimepicker">
                                <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="custom-file" id="customFile" lang="es">
                            {{ persona_form.imagen }}
                            <label class="custom-file-label" for="id_imagen">
                                <span class="text-black-50">Seleccione una foto carnet</span>
                            </label>
                        </div>
                        <!-- Uploaded image area-->
                        <p class="font-italic text-black-50 text-center mt-2">
                            La imagen subida se representará dentro del siguiente cuadro.
                        </p>
                        <div class="image-area mt-3">
                            <img id="imageResult" src="#" alt=""
                                 style="max-height: 300px; max-width: 300px;"
                                 class="img-fluid rounded mx-auto d-block"/>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                    <button class="btn btn-secondary" type="reset" onclick="resetPersonaForm()">
                        <i class="fas fa-eraser"></i> Limpiar
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>
<script>
    $('#id_sexo').select2({
        theme: 'bootstrap4',
        placeholder: 'Seleccione un sexo',
        allowClear: true,
        width: '100%',
        language: 'es',
        dropdownParent: $('#ModalAddPersona')
    });
    $('#id_fecha_nacimiento').datetimepicker({
        "format": "DD/MM/YYYY",
        "locale": "es-AR",
        "date": null,
        "minDate": "01/01/1900",
        "maxDate": Date.now(),
    });
    $('#id_dni').on('change', function () {
        let dni = $(this).val();
        if (dniValido(dni)) {
            $(this).addClass('is-valid');
            $(this).removeClass('is-invalid');
            ajaxGetPersona(dni)
        } else {
            swal.fire({
                position: 'top-end',
                title: 'Error',
                text: 'El DNI ingresado no es válido',
                icon: 'error',
                confirmButtonText: 'Aceptar'
            });
            $(this).addClass('is-invalid');
            $(this).removeClass('is-valid');
        }
    });

    function dniValido(dni) {
        // Validar que el DNI solo contenga números, tenga al menos 7 dígitos, no comience con 0 y no haya espacios
        return dni.length >= 7 && !dni.startsWith('0') && $.isNumeric(dni) && !dni.includes(' ');
    }

    function ajaxGetPersona(dni) {
        $.ajax({
            url: "{% url 'admin-socio-ajax' %}",
            type: "GET",
            delay: 250,
            data: {
                'action': 'get_persona',
                'dni': dni
            },
            success: function (data) {
                if (data['persona']) {
                    // En este caso la persona ya existe en la base de datos, pero no es socio.
                    let persona = data['persona'];
                    Swal.fire({
                        position: 'top-end',
                        title: 'Persona encontrada',
                        html:
                            '<p>Se ha encontrado la siguiente persona con el DNI ingresado. ¿Desea seleccionarla?</p>' +
                            '<li class="list-group-item"><b>Nombre: </b>' + persona['nombre'] + '</li>' +
                            '<li class="list-group-item"><b>Apellido: </b>' + persona['apellido'] + '</li>',
                        icon: 'info',
                        confirmButtonText: 'Seleccionar',
                        confirmButtonColor: '#3085d6',
                        showCancelButton: true,
                        cancelButtonText: 'Cancelar',
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        allowEnterKey: false,
                        stopKeydownPropagation: false,
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Si se confirma se cierra el modal y se selecciona la persona en el select
                            $('#ModalAddPersona').modal('hide');
                            $('#id_persona').val(persona['id']).trigger('change');
                        } else {
                            resetPersonaForm();
                        }
                    });
                } else if (data['persona_is_socio']) {
                    // En este caso la persona ya existe en la base de datos y es socio.
                    Swal.fire({
                        position: 'top-end',
                        title: 'Error',
                        text: 'Se ha encontrado un socio con el DNI ingresado. Intente con otro DNI.',
                        icon: 'error',
                        confirmButtonText: 'Aceptar',
                        confirmButtonColor: '#3085d6',
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        allowEnterKey: false,
                        stopKeydownPropagation: false,
                    }).then((result) => {
                        if (result.isConfirmed) {
                            resetPersonaForm();
                        }
                    });
                } else if (data['persona_is_deleted']) {
                    // En este caso la persona ya existe en la base de datos, pero está eliminada.
                    Swal.fire({
                        title: 'Error',
                        text: 'Se ha encontrado una persona dada de baja con el DNI ingresado. Intente con otro DNI.',
                        icon: 'error',
                        confirmButtonText: 'Aceptar',
                        confirmButtonColor: '#3085d6',
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        allowEnterKey: false,
                        stopKeydownPropagation: false,
                    }).then((result) => {
                        if (result.isConfirmed) {
                            resetPersonaForm();
                        }
                    });
                }
            },
            error: function (data) {
                alert('Error');
                resetPersonaForm();
            }
        });
    }

    // Imagen preview
    document.querySelector('.custom-file-input').addEventListener('change', function (e) {
        const fileName = document.getElementById("id_imagen").files[0].name;
        const nextSibling = e.target.nextElementSibling;
        nextSibling.innerText = fileName
        const reader = new FileReader();
        reader.onload = function () {
            const output = document.getElementById('imageResult');
            output.src = reader.result;
        };
        reader.readAsDataURL(e.target.files[0]);
    });

    // Evento submit del formulario de persona
    $('#formPersona').on('submit', function (e) {
        e.preventDefault();
        let form = new FormData(this);
        form.append('action', 'add_persona');
        $.ajax({
            url: "{% url 'admin-socio-ajax' %}",
            type: 'POST',
            data: form,
            dataType: 'json',
            contentType: false,
            processData: false,
            success: function (data) {
                if (!data.hasOwnProperty('error')) {
                    let persona = data['persona'];
                    let newOption = new Option(persona['__str__'], data.id, false, true);
                    $('#id_persona').append(newOption).trigger('change');
                    resetPersonaForm();
                    $('#ModalAddPersona').modal('hide');
                    Swal.fire({
                        position: 'top-end',
                        icon: 'success',
                        title: 'Bien hecho!',
                        text: 'Se ha agregado una nueva persona',
                        showConfirmButton: false,
                        timer: 5000,
                        timerProgressBar: true,
                    })
                    document.body.classList.remove('swal2-height-auto');
                } else {
                    let errors = []
                    $.each(data.error, function (key, value) {
                        errors.push(value);
                    });
                    Swal.fire({
                        position: 'top-end',
                        icon: 'error',
                        title: 'Ocurrió un error',
                        text: errors.join('\n'),
                        showConfirmButton: true,
                    })
                    document.body.classList.remove('swal2-height-auto');
                }
            },
            error: function (data) {
                alert('Error al guardar la persona');
            }
        });
    });

    function resetPersonaForm() {
        $('#formPersona').trigger('reset');
        $('#id_sexo').val(null).trigger('change');
        $('#id_imagen').val('').next().html('<span class="text-muted">Seleccione una foto carnet</span>');
        $('#imageResult').attr('src', '');
    }
</script>

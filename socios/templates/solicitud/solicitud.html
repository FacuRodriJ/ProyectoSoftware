<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - RESERVÁ</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
          integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <!-- Bootstrap 4.6 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
          integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N"
          crossorigin="anonymous">
    <!-- iCheck Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/icheck-bootstrap@3.0.1/icheck-bootstrap.min.css">
    <!-- AdminLTE 3 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
    <!-- Select2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@x.x.x/dist/select2-bootstrap4.min.css">
</head>

<body class="hold-transition register-page">
<div class="register-box">
    <div class="card card-outline card-primary">
        <div class="card-header text-center">
            <a href="{% url 'index' %}" class="h1">RESERVÁ</a>
        </div>
        <div class="card-body">
            <form method="post" id="formSolicitud">
                {% csrf_token %}
                <input type="hidden" name="action" value="{{ value }}">
                <div class="input-group mb-3">
                    {{ form.dni }}
                    <div class="input-group-append">
                        <div class="input-group-text">
                            <span class="fas fa-user"></span>
                        </div>
                    </div>
                </div>
                <div class="input-group mb-3">
                    {{ form.email }}
                    <div class="input-group-append">
                        <div class="input-group-text">
                            <span class="fas fa-envelope"></span>
                        </div>
                    </div>
                </div>
                <div class="input-group mb-3">
                    {{ form.nombre }}
                    <div class="input-group-append">
                        <div class="input-group-text">
                            <span class="fas fa-envelope"></span>
                        </div>
                    </div>
                </div>
                <div class="input-group mb-3">
                    {{ form.apellido }}
                    <div class="input-group-append">
                        <div class="input-group-text">
                            <span class="fas fa-envelope"></span>
                        </div>
                    </div>
                </div>
                <div class="input-group mb-3">
                    {{ form.sexo }}
                </div>
                <div class="form-group">
                    <div class="input-group" id="div_id_fecha_nacimiento"
                         data-target-input="nearest">
                        <input type="text" name="fecha_nacimiento" autocomplete="off"
                               placeholder="Fecha de nacimiento"
                               class="form-control  datetimepicker-input"
                               data-toggle="datetimepicker" data-target="#id_fecha_nacimiento"
                               required=""
                               id="id_fecha_nacimiento">
                        <div class="input-group-append" data-target="#id_fecha_nacimiento"
                             data-toggle="datetimepicker">
                            <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                        </div>
                    </div>
                </div>
                <div class="input-group mb-3">
                    {{ form.categoria }}
                </div>
                <div class="input-group mb-3">
                    <label for="">{{ form.imagen.label }}</label>
                    {{ form.imagen }}
                </div>
                <div class="row mb-2">
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary btn-block">Enviar solicitud</button>
                    </div>
                </div>
            </form>
            <p>
                <a href="{% url 'signup' %}" class="text-center">Soy socio pero sin cuenta</a>
            </p>
        </div>
    </div>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.1.min.js"
        integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
<!-- Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct"
        crossorigin="anonymous"></script>
<!-- AdminLTE 3 -->
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.33/dist/sweetalert2.all.min.js"></script>
<!-- Django Tempus Dominus -->
<link href="//cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.39.0/css/tempusdominus-bootstrap-4.min.css"
      media="all" rel="stylesheet">
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.39.0/js/tempusdominus-bootstrap-4.min.js"></script>
<!-- Select2 -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $('#id_categoria').select2({
        theme: 'bootstrap4',
        allowClear: true,
        placeholder: 'Seleccione una categoria',
        width: '100%',
        language: 'es'
    }).prop('disabled', true);
    $('#id_fecha_nacimiento').datetimepicker({
        "format": "DD/MM/YYYY",
        "icons": {"time": "fa fa-clock-o"},
        "locale": "es-AR",
        "date": null,
        "minDate": "1900-01-01",
        "maxDate": Date.now(),
    });
    $('#id_sexo').select2({
        theme: 'bootstrap4',
        placeholder: 'Seleccione un sexo',
        allowClear: true,
        width: '100%',
        language: 'es'
    });
</script>
<script>
    $(document).ready(function () {
        let select_categoria = $('#id_categoria');
        // Obtener con ajax las categorias de socio según la edad
        $('#id_fecha_nacimiento').on('change.datetimepicker', function (e) {
            // Verificar que el input no esté vacío
            if ($(this).val()) {
                $.ajax({
                    // Pasar una edad por GET para filtrar las categorias en la vista
                    url: window.location.pathname,
                    type: 'POST',
                    data: {
                        'action': 'get_categoria',
                        'fecha_nacimiento': $(this).val(),
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    dataType: 'json',
                    success: function (data) {
                        // Limpiar el select
                        select_categoria.empty();
                        // Habilitar el select
                        select_categoria.prop('disabled', false);
                        // Agregar las categorias al select
                        $.each(data, function (key, value) {
                            select_categoria.append('<option value="' + value.id + '">' + value.nombre + ' $' + value.cuota + '</option>');
                        });
                    },
                });
            } else {
                // Limpiar el select
                select_categoria.empty();
                // Deshabilitar el select
                select_categoria.prop('disabled', true);
            }
        });
    });

    // Función para obtener la edad a partir de la fecha de nacimiento
    function getAge(dateString) {
        let today = new Date();
        let birthDate = new Date(dateString);
        let age = today.getFullYear() - birthDate.getFullYear();
        let m = today.getMonth() - birthDate.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
            age--;
        }
        return age;
    }
</script>
<script>
    // Script para el formulario de socio
    $('#formSolicitud').on('submit', function (e) {
        e.preventDefault();
        let form = new FormData(this);
        form.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        form.append('action', '{{ action }}');
        $.ajax({
            url: window.location.pathname,
            type: 'POST',
            data: form,
            dataType: 'json',
            contentType: false,
            processData: false,
            success: function (data) {
                if (!data.hasOwnProperty('error')) {
                    window.location.pathname = '{% url 'login' %}';
                } else {
                    let errors = []
                    // Si data error es un objeto pushear los errores al array
                    if (typeof data.error === 'object') {
                        $.each(data.error, function (key, value) {
                            errors.push(value);
                        });
                    } else {
                        errors = data.error
                    }
                    Swal.fire({
                        position: 'top-end',
                        icon: 'error',
                        title: 'Ocurrió un error',
                        text: errors,
                        showConfirmButton: true,
                    })
                    document.body.classList.remove('swal2-height-auto');
                }
            },
            error: function (data) {
                alert('Error al enviar la solicitud');
            }
        });
    });
</script>
<!-- Si la vista envía mensajes, se muestran con SweetAlert -->
{% include 'includes/message.html' %}
</body>
</html>